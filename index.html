<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ëª¬ìŠ¤í„° ì›Œë¡œë“œ ì¥ë¹„ ì‹œë®¬ë ˆì´ì…˜</title>
  <style>
:root{
  /* Dashboard-dark (football manager) ëŠë‚Œ */
  --bg:#0b0f16;
  --ink:#e9eef9;
  --muted: rgba(233,238,249,.70);
  --muted2: rgba(233,238,249,.52);

  /* cards */
  --glass: rgba(18, 24, 38, .85);
  --glass2: rgba(18, 24, 38, .70);

  /* strokes/shadows */
  --stroke: rgba(255,255,255,.10);
  --stroke2: rgba(255,255,255,.08);
  --shadow: 0 18px 55px rgba(0,0,0,.55);

  /* âœ… ê°ì§€ê²Œ */
  --radius: 0px;

  /* accents (ì£¼í™©/ì—°ë‘ í¬ì¸íŠ¸) */
  --ok:#2ee59d;
  --danger:#ff5b6e;
  --accent:#ff9f43; /* primary */
  --accent2:#78f08a; /* secondary */
}
    *{box-sizing:border-box}
body{
  margin:0; min-height:100vh;
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
  color:var(--ink);
  background:
    radial-gradient(900px 600px at 20% 15%, rgba(255,159,67,.10), transparent 60%),
    radial-gradient(900px 600px at 80% 25%, rgba(120,240,138,.08), transparent 60%),
    radial-gradient(1100px 800px at 50% 90%, rgba(99,102,241,.08), transparent 62%),
    linear-gradient(180deg, #0b0f16, #0a0e14 60%, #080b10);
  padding:14px;
}
.wrap{max-width:none;width:100%;margin:0 auto;display:grid;gap:14px}
.chrome{
  width:100%;
  min-height: calc(100vh - 28px);
  border:1px solid var(--stroke);
  border-radius: 0;
  background: rgba(10,14,20,.75);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  overflow:hidden;
}
.chromeTop{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:12px 14px;
  border-bottom:1px solid var(--stroke2);
  background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.18));
  flex-wrap:wrap;
}
.titleBox{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .traffic{
      display:flex; gap:8px; align-items:center;
      padding:10px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
    }
    .dot{width:10px;height:10px;border-radius:999px;opacity:.9}
    .dot.r{background:#ff5f57} .dot.y{background:#ffbd2e} .dot.g{background:#28c840}
    h1{margin:0;font-size:14px;font-weight:990;letter-spacing:-.2px}
  .brandIcon{width:34px;height:34px;object-fit:contain;border-radius:4px;box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);}

    .sub{color:var(--muted);font-size:12px;font-weight:800}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{
  appearance:none;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color:var(--ink);
  padding:9px 12px;
  border-radius: 0;
  font-weight:900;
  font-size:12px;
  cursor:pointer;
  transition:.12s transform,.12s background,.12s border,.12s opacity;
  white-space:nowrap;
}
.btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.22)}
.btn.primary{border-color: rgba(255,159,67,.70); background: rgba(255,159,67,.16);}
.btn.danger{border-color: rgba(255,91,110,.70); background: rgba(255,91,110,.14);}
.btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .pill{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      padding:10px 12px;
      border-radius: 16px;
      font-weight:200;
      font-size:12px;
    }

    .grid{display:grid;grid-template-columns: 1fr 1fr; gap:14px; padding:14px; align-items:stretch}
    @media (max-width: 1120px){ .grid{grid-template-columns:1fr} }
.card{
  display:flex;flex-direction:column;
  border:1px solid var(--stroke);
  background: linear-gradient(180deg, rgba(18,24,38,.92), rgba(12,16,26,.88));
  border-radius: 0;
  box-shadow: 0 16px 48px rgba(0,0,0,.45);
  overflow:hidden;
}
.cardHead{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:10px 12px;
  border-bottom:1px solid var(--stroke2);
  background: rgba(0,0,0,.22);
  flex-wrap:wrap;
}
.cardHead b{font-size:13px;font-weight:990}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{
  appearance:none;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color:var(--ink);
  padding:8px 11px;
  border-radius: 0;
  font-weight:100;
  font-size:15px;
  cursor:pointer;
  transition:.12s transform,.12s background,.12s border;
}
.tab:hover{transform: translateY(-1px); background: rgba(255,255,255,.06);}
.tab.active{border-color: rgba(255,159,67,.75); background: rgba(255,159,67,.14);}
select, input[type="number"]{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.28);
  color:var(--ink);
  border-radius: 0;
  padding:9px 10px;
  font-weight:850;
  font-size:12px;
  outline:none;
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:12px;font-weight:800}
.divider{height:1px;background: rgba(255,255,255,.08);}
.iconGrid{padding:12px;display:grid;grid-template-columns: repeat(6,minmax(0,1fr)); gap:10px}
    @media (max-width: 1100px){ .iconGrid{grid-template-columns: repeat(5,minmax(0,1fr));} }
    @media (max-width: 900px){ .iconGrid{grid-template-columns: repeat(4,minmax(0,1fr));} }
    @media (max-width: 640px){ .iconGrid{grid-template-columns: repeat(3,minmax(0,1fr));} }
.tile{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(7,10,16,.55);
  border-radius: 0;
  padding:10px;
  cursor:pointer;
  transition:.12s transform,.12s background,.12s border;
  min-height:96px;
  position:relative;
  overflow:hidden;
}
.tile:hover{transform: translateY(-1px); background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.18);}
.tileTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .qty{font-variant-numeric: tabular-nums; font-weight:990; font-size:12px; padding:6px 9px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06);}
    .icon{
      width:34px;height:34px;border-radius:14px; display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06);
      overflow:visible;
    }
 .icon{
  width:64px;
  height:64px;
  margin:0 auto 6px auto;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:visible;
}

.icon img{
  width:100%;
  height:100%;
  object-fit:contain;
}

/* ====== ì•„ì´í…œ ì¹´ë“œ ë‚´ë¶€ ì •ë ¬ ====== */
.tile{
  text-align:center;
  padding:12px;
}

/* ì•„ì´í…œ ì´ë¦„ */
.name{
  margin-top:6px;
  font-size:14px;
  font-weight:700;
  line-height:1.2;
}

/* ì–¸ì»¤ë¨¼ / ë ˆì–´ í…ìŠ¤íŠ¸ */
.rar{
  margin-top:4px;
  font-size:12px;
  font-weight:700;
  color:#9ad4ff;
}

/* ìˆ˜ëŸ‰ ë±ƒì§€ (x4) ìœ„ì¹˜ ì¡°ì • */
.qty{
  position:absolute;
  top:6px;
  right:6px;
  padding:2px 8px;
  font-size:11px;
  border-radius:999px;
}


    .combine{padding:12px;display:grid;gap:10px}
    .line{display:flex;gap:10px;align-items:stretch;flex-wrap:wrap}
    .slot{
      flex: 1 1 260px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius: 18px;
      padding:12px;
      min-width: 220px;
    }
    .slotHead{display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,.08);margin-bottom:10px;
      font-weight:990;font-size:1px;}
    .slotHead span{color:var(--muted);font-size:12px;font-weight:850}
    .pick{
      display:flex;gap:9px;align-items:center;
      border:1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      padding:10px;
      background: rgba(255,255,255,.03);
      min-height:10px;
    }
    .empty{color:var(--muted);font-weight:900}
    .eq{display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:990;color:rgba(238,244,255,.86);padding:6px 4px;user-select:none}
    .out{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 16px;
      padding:12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }
    .strong{color:var(--ink);font-weight:990}
    .ok{color:var(--ok)} .bad{color:var(--danger)}

    .kpi{display:grid;grid-template-columns: repeat(3,minmax(0,1fr)); gap:10px}
    @media (max-width: 900px){ .kpi{grid-template-columns:1fr 1fr} }
    @media (max-width: 640px){ .kpi{grid-template-columns:1fr} }
    .metric{border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.16);border-radius: 18px;padding:12px}
    .metric .k{color:var(--muted);font-weight:950;font-size:12px}
    .metric .v{margin-top:6px;font-size:16px;font-weight:990;font-variant-numeric:tabular-nums}
    .metric .u{margin-top:2px;color:var(--muted2);font-weight:850;font-size:12px}

    .log{padding:0 12px 12px 12px; display:grid; gap:8px; max-height:260px; overflow:auto}
    .logItem{border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.14); border-radius: 16px; padding:10px; font-size:12px; line-height:1.4}
    .logItem .t{font-weight:990} .logItem .s{color:var(--muted);font-weight:800}

    .invPanel{padding:7px;display:grid;gap:10px}
    .invTable{border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.14); border-radius: 18px; overflow:hidden}
    .invTableHead{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .invTableHead b{font-size:13px}
/* ì¬ë£Œ ì¹©(ì¼ë ¬ í‘œì‹œ) */
.matRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.matChip{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.16);
  font-weight:950;
  font-size:12px;
}
.matChip .matK{color:var(--muted); font-weight:950}
.matChip .matV{color:var(--ink); font-variant-numeric: tabular-nums; font-weight:990}

/* ====== ì¬ë£Œ ì•„ì´ì½˜(í˜¼ëˆ/ì¸ë‚´/íŒŒê´´/ë³´ì„) ====== */
.metric .k{display:flex; align-items:center; gap:8px;}
.matIcon{
  width:22px;
  height:22px;
  object-fit:contain;
  flex:0 0 auto;
}
/* ìƒë‹¨ ì¬ë£Œì¹© ì•„ì´ì½˜ */
.matChip{gap:8px;}
.matChip .matI{
  width:24px;height:24px;          /* âœ… ì•„ì´ì½˜ ì˜ë¦¼ ë°©ì§€ */
  padding:2px;                     /* âœ… ì´ë¯¸ì§€ ì—¬ë°± */
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:visible;
  flex:0 0 auto;
  line-height:0;
}
.matChip .matI img{
  max-width:100%;
  max-height:100%;
  width:auto;
  height:auto;
  object-fit:contain;
  display:block;
}

    .invGrid{display:grid;grid-template-columns: 260px repeat(9, clamp(64px, 6vw, 84px));}
    .cell{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.06); border-right:1px solid rgba(255,255,255,.06); font-size:11px; font-weight:850; color:var(--muted); text-align:center}
    .cell.left{text-align:left; color:var(--ink); font-weight:990; display:flex; gap:10px; align-items:center}
    .cell .miniIcon{width:30px;height:30px;border-radius:10px;border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); overflow:hidden; flex:0 0 auto}
    .cell .miniIcon img{width:100%;height:100%;object-fit:contain}
    .cell.count{color:var(--ink); font-weight:990; font-variant-numeric: tabular-nums}

    .modalOverlay{position:fixed;inset:0;background: rgba(0,0,0,.60);display:none;align-items:center;justify-content:center;padding:18px;z-index:9999}
    .modalOverlay.show{display:flex}
.modal{
  width:min(980px, 100%);
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(18,24,38,.98), rgba(10,12,18,.96));
  border-radius: 0;
  box-shadow: 0 28px 120px rgba(0,0,0,.70);
  backdrop-filter: blur(10px);
  overflow:hidden;
  max-height: calc(100vh - 48px);
  display:flex;
  flex-direction:column;
}
.mHead{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);flex-wrap:wrap}
    .mHead h3{margin:0;font-size:14px;font-weight:990}
    .mBody{padding:10px 14px 12px 14px; overflow:auto; flex:1 1 auto;}
    .mHead{flex:0 0 auto}
    .mFoot{flex:0 0 auto}
    .mTabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .mTab{appearance:none;border:1px solid rgba(255,255,255,.14);background: rgba(255,255,255,.06);color:var(--ink);
      padding:8px 10px;border-radius:999px;font-weight:950;font-size:12px;cursor:pointer;transition:.14s transform,.14s background,.14s border;}
    .mTab:hover{transform: translateY(-1px); background: rgba(255,255,255,.08);}
    .mTab.active{border-color: rgba(125,211,252,.55); background: rgba(125,211,252,.14);}
    .mGrid{display:grid;grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:12px; margin-top:12px; align-items:start}
    @media (max-width: 920px){ .mGrid{grid-template-columns:1fr} }
    .mCard{border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.16);border-radius: 18px;padding:10px}
    .mCardHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,.08);margin-bottom:10px}

    .mCardHead .mHeadL{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    /* í—¤ë”ì— ë“¤ì–´ê°€ëŠ” ì•„ì´ì½˜ì€ ì‘ê²Œ */
    .mCardHead .icon{
      width:20px;height:20px;border-radius:8px;
      background:rgba(255,255,255,.10);
    }
    .mCardHead .icon img{width:14px;height:14px;object-fit:contain;display:block;}
    .mCardHead b{font-size:13px}
    .mInputs{display:grid;grid-template-columns: repeat(3, minmax(0,1fr)); gap:8px}
    .mInputs label{display:grid;gap:6px;font-size:11px;font-weight:850;color:var(--muted);min-width:0}
    .mInputs input{width:100%;min-width:0;text-align:right;padding:8px 9px;border-radius: 12px}
    .mFoot{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 16px;border-top:1px solid rgba(255,255,255,.10);flex-wrap:wrap}
  
    /* v5 responsive widen / prevent clipping */
    .invTable{overflow-x:auto;}
    .invGrid{min-width: 900px;} /* desktop baseline so columns don't collapse */
    @media (max-width: 1020px){
      .wrap{max-width:none;width:100%;margin:0 auto;display:grid;gap:14px}
      body{padding:14px;}
    }
    @media (max-width: 680px){
      .grid{padding:12px;}
      .invTable{border-radius: 18px;}
      .invGrid{min-width: 860px;} /* allow horizontal scroll instead of clipping */
      .invPanel .row{justify-content:flex-start;}
      .invPanel .row .btn{flex:1 1 auto;}
      .tabs{gap:6px;}
      .tab{padding:8px 10px;font-size:12px;}
    }

  
    

  
    /* v7: fill window + cleaner layout */
    .cardHead{flex:0 0 auto}
    .iconGrid{flex:0 0 auto}
    .combine{flex:0 0 auto}
    .log{flex:1 1 auto; min-height:80px}
    .invPanel{flex:1 1 auto; display:flex; flex-direction:column}
    .invTable{flex:1 1 auto}
    .invGrid{width:100%}

  
    /* v7.1 height align + clean layout */
    .chrome{min-height: calc(100vh - 36px);}
    .grid{align-items:stretch;}
    .card{display:flex; flex-direction:column; min-height: calc(100vh - 180px);}
    .iconGrid{flex:0 0 auto;}
    .combine{flex:0 0 auto;}
    .log{flex:1 1 auto; overflow:auto;}
    .invPanel{flex:1 1 auto; display:flex; flex-direction:column; gap:10px;}
    .invTable{flex:1 1 auto; overflow:auto;}

  

/* hide iTunes traffic lights (ìš”ì²­) */
.traffic{display:none !important;}
/* ì¡°í•© íƒ­: ìŠ¬ë¡¯ ì•„ì´ì½˜ì´ ì¹¸ì— ì˜ˆì˜ê²Œ ë§ê²Œ */
#slotA .icon, #slotB .icon{
  width: 56px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;       /* ì´ë¯¸ì§€ê°€ ë„˜ì¹˜ë©´ ì•ˆì—ì„œë§Œ */
  border-radius: 0;       /* ê°ì§€ê²Œ */
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.14);
  flex: 0 0 auto;
}

/* ì¡°í•© íƒ­: ì•„ì´ì½˜ ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€ + ì¤‘ì•™ */
#slotA .icon img, #slotB .icon img{
  width: 100%;
  height: 100%;
  object-fit: contain;    /* ì¤‘ìš”: coverê°€ ì•„ë‹ˆë¼ contain */
  object-position: center;
  display:block;
}
.matIcon{
  width:22px;
  height:22px;
  margin-right:6px;
  vertical-align:middle;
  object-fit:contain;
}

/* ì¬ë£Œ ë°•ìŠ¤ ë¬¶ìŒ */
.materialBox{
  margin-top:16px;
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:12px;
}

/* ëª¨ë°”ì¼ ëŒ€ì‘ */
@media (max-width: 700px){
  .materialBox{
    grid-template-columns: 1fr 1fr;
  }
}

/* âœ… ê°ì§€ê²Œ: ë¼ìš´ë“œ ì œê±° */
.chrome,
.card,
.btn,
.pill,
.tab,
.tile,
.slot,
.out,
.metric,
.logItem,
.invTable,
.modal,
.mTab,
.mCard,
.invTableHead,
.pick,
select,
input[type="number"],
.cell .miniIcon,
.icon{
  border-radius: 0 !important;
}


/* =========================
   ğŸ“± Mobile-first tweaks
   ========================= */
@media (max-width: 820px){
  body{padding:10px;}
  .chrome{min-height:auto;}
  .grid{grid-template-columns:1fr; padding:12px;}
  .card{min-height:auto;}
}

/* phone */
@media (max-width: 520px){
  body{padding:8px;}
  .chromeTop{padding:10px 10px; gap:10px;}
  .titleBox{gap:10px;}
  h1{font-size:13px;}
  .sub{font-size:11px;}
  .brandIcon{width:26px;height:26px;border-radius:3px;}
  .actions{width:100%;}
  .actions .btn{flex:1 1 auto; width:100%; justify-content:center;}

  .cardHead{padding:10px 10px;}
  .tabs{width:100%;}
  .tabs .tab{flex:1 1 auto; text-align:center;}
  .row{width:100%;}
  select, input[type="number"]{width:100%;}
  #rarityFilter{min-width: 160px;}

  /* icon tiles: 2 columns on small phones */
  .iconGrid{grid-template-columns: repeat(2, minmax(0,1fr)) !important;}

  /* combine area: stack */
  .line{flex-direction:column; align-items:stretch;}
  .eq{display:none;}
  .slot{flex:1 1 auto; min-width:unset;}
  .pick{min-height:56px;}
  .slotHead{font-size:12px;}
  .out{font-size:12px;}

  /* materials: 2 columns */
  .materialBox{grid-template-columns: 1fr 1fr;}

  /* right inventory header chips wrap nicely */
  .invTableHead{gap:8px;}
  .matRow{width:100%; margin-left:0 !important; justify-content:flex-start;}
  .matChip{padding:7px 8px; font-size:11px;}
  .matChip .matI{width:22px;height:22px;padding:2px;}

  /* modal: make it usable on phones */
  .modalOverlay{padding:10px;}
  .modal{max-height: calc(100vh - 20px);}
  .mHead{padding:12px 12px;}
  .mBody{padding:10px 10px;}
  .mFoot{padding:10px 12px;}
  .mTabs{gap:6px;}
  .mTab{flex:1 1 auto; text-align:center; border-radius:0; padding:8px 8px;}
  .mGrid{grid-template-columns:1fr;}
  .mInputs{grid-template-columns: 1fr 1fr;}
  .mInputs label{min-width:0;}
  .mInputs input{padding:8px 8px;}
  #matCard .mInputs{grid-template-columns: 1fr 1fr !important;}
}

</style>
</head>
<body>
  <div class="wrap">
    <div class="chrome">
      <div class="chromeTop">
        <div class="titleBox">
          <div class="traffic" aria-hidden="true">
            <div class="dot r"></div><div class="dot y"></div><div class="dot g"></div>
          </div>
          <div>
            <h1><img class="brandIcon" src="icons/ë§ˆí¬.jpg" alt="ë§ˆí¬">ëª¬ìŠ¤í„° ì›Œë¡œë“œ ì¥ë¹„ ì‹œë®¬ë ˆì´ì…˜</h1>
            <div class="sub">Made By ì¨ë°‹</div>
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" id="openInv">ì¸ë²¤í† ë¦¬ ì„¤ì •</button>
</div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="cardHead">
            <b>ë³´ìœ  ì¥ë¹„ (ì•„ì´ì½˜)</b>
            <div class="row">
              <div class="tabs" id="gearTabs"></div>
              <select id="rarityFilter" title="ë“±ê¸‰ í•„í„°"></select>
              <button class="btn" id="clearSlots">ìŠ¬ë¡¯ ë¹„ìš°ê¸°</button>
            </div>
          </div>

          <div class="iconGrid" id="iconGrid"></div>

          <div class="divider"></div>

          <div class="combine">
            <div class="row" style="justify-content:space-between">
              <b style="font-size:13px">ì¡°í•©</b>
              <span class="muted">ì²«ë²ˆì§¸ ì¥ë¹„(ë‹¤ìŒ ë“±ê¸‰ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ) + ë‘ë²ˆì§¸ ì¥ë¹„(ì¬ë£Œ) = ì²«ë²ˆì§¸ ë“±ë¡ëœ ì¥ë¹„ ì—…ê·¸ë ˆì´ë“œ</span>
            </div>

            <div class="line">
              <div class="slot">
                <div class="slotHead">ì²«ë²ˆì§¸ ì¥ë¹„ <span>(ê²°ê³¼ íƒ€ì…)</span></div>
                <div class="pick" id="slotA"><div class="empty">ì•„ì´ì½˜ì„ í´ë¦­í•´ì„œ ì„ íƒ</div></div>
                <div class="muted" style="margin-top:8px">â€» A, BëŠ” <span class="strong">ê°™ì€ ë“±ê¸‰</span>ì´ì–´ì•¼ í•¨</div>
              </div>

              <div class="eq">+</div>

              <div class="slot">
                <div class="slotHead">ë‘ë²ˆì§¸ ì¥ë¹„ <span>(ì¬ë£Œ ì†Œëª¨)</span></div>
                <div class="pick" id="slotB"><div class="empty">ì•„ì´ì½˜ì„ í´ë¦­í•´ì„œ ì„ íƒ</div></div>
                <div class="muted" style="margin-top:8px">â€» (ì›í•˜ë©´) ê°™ì€ ë¶€ìœ„ë¡œ ì œí•œ ê°€ëŠ¥</div>
              </div>

              <div class="eq">=</div>

              <div class="slot">
                <div class="slotHead">ê²°ê³¼ <span>(ì¸ë²¤í† ë¦¬ì— +1)</span></div>
                <div class="out" id="outBox">Aì™€ Bë¥¼ ì„ íƒí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>

                <div class="row" style="margin-top:10px;justify-content:space-between">
                  <div class="row" style="gap:8px">
                    <span class="muted">ì—¬ëŸ¬ë²ˆ:</span>
                    <input id="craftTimes" type="number" min="1" step="1" value="1" style="width:86px" />
                  </div>
                  <div class="row">
                    <button class="btn" id="previewCraft" disabled>ë¯¸ë¦¬ë³´ê¸°</button>
                    <button class="btn primary" id="doCraft" disabled>ì¡°í•© ì‹¤í–‰</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- â–¼ ì†Œëª¨ ì¬ë£Œ ì˜ì—­ (í•˜ë‹¨ ê³ ì •) -->
<div class="kpi materialBox">
  <div class="metric">
    <div class="k">
      <img src="./icons/ì¬ë£Œ/í˜¼ëˆ.jpg" class="matIcon">
      í˜¼ëˆ
    </div>
    <div class="v" id="needChaos">0</div>
    <div class="u">í˜¼ëˆì˜ ê°•í™” ì •ìˆ˜</div>
  </div>

  <div class="metric">
    <div class="k">
      <img src="./icons/ì¬ë£Œ/ì¸ë‚´.jpg" class="matIcon">
      ì¸ë‚´
    </div>
    <div class="v" id="needPatience">0</div>
    <div class="u">ì¸ë‚´ì˜ ê°•í™” ì •ìˆ˜</div>
  </div>

  <div class="metric">
    <div class="k">
      <img src="./icons/ì¬ë£Œ/íŒŒê´´.jpg" class="matIcon">
      íŒŒê´´
    </div>
    <div class="v" id="needDestruction">0</div>
    <div class="u">íŒŒê´´ì˜ ê°•í™” ì •ìˆ˜</div>
  </div>

  <div class="metric">
    <div class="k">
      <img src="./icons/ë³´ì„.jpg" class="matIcon">
      ë³´ì„
    </div>
    <div class="v" id="needJewel">0</div>
    <div class="u">ì¡°í•© ë³´ì„</div>
  </div>
</div>

<div class="row" style="justify-content:space-between">
              <div class="row">
                <button class="btn" id="clearLog">ë¡œê·¸ ë¹„ìš°ê¸°</button>
              </div>
              <span class="muted">â€» ì¸ë²¤í† ë¦¬/ì¬ë£ŒëŠ” ë¡œì»¬ì— ì €ì¥ë¨</span>
            </div>
          </div>

          <div class="log" id="log"></div>
        </div>

        <div class="card">
          <div class="cardHead">
            <b>ì¸ë²¤í† ë¦¬ (ì‹¤ì‹œê°„)</b>
            <div class="row">
              <div class="tabs" id="invTabsRight"></div>
            </div>
          </div>

          <div class="invPanel">
            <div class="invTable">
              <div class="invTableHead">
                <b id="invTitle">ì‹ ë°œ</b>
                <span class="muted">ì¡°í•©/ì €ì¥ ì‹œ ì¦‰ì‹œ ê°±ì‹ </span>
                
                <div class="matRow" style="margin-left:auto">
                  <div class="matChip" title="í˜¼ëˆì˜ ì •ìˆ˜ (ì‹¤ì‹œê°„)"><span class="matI"><img alt="" src="./icons/ì¬ë£Œ/í˜¼ëˆ.jpg" onerror="this.style.display='none'"></span><span class="matK">í˜¼ëˆ</span><span class="matV" id="invMatChaos">0</span></div>
                  <div class="matChip" title="ì¸ë‚´ì˜ ì •ìˆ˜ (ì‹¤ì‹œê°„)"><span class="matI"><img alt="" src="./icons/ì¬ë£Œ/ì¸ë‚´.jpg" onerror="this.style.display='none'"></span><span class="matK">ì¸ë‚´</span><span class="matV" id="invMatPatience">0</span></div>
                  <div class="matChip" title="íŒŒê´´ì˜ ì •ìˆ˜ (ì‹¤ì‹œê°„)"><span class="matI"><img alt="" src="./icons/ì¬ë£Œ/íŒŒê´´.jpg" onerror="this.style.display='none'"></span><span class="matK">íŒŒê´´</span><span class="matV" id="invMatDestruction">0</span></div>
                  <div class="matChip" title="ë³´ì„ (ì‹¤ì‹œê°„)"><span class="matI"><img alt="" src="./icons/ë³´ì„.jpg" onerror="this.style.display='none'"></span><span class="matK">ë³´ì„</span><span class="matV" id="invMatJewel">0</span></div>
                </div>
</div>
              <div class="invGrid" id="invMatrix"></div>
            </div>

            <div class="row" style="justify-content:space-between">
              <span class="muted">í‘œì‹œëŠ” â€œì¢…ë¥˜ Ã— ë“±ê¸‰â€ ìˆ˜ëŸ‰í‘œ</span>
</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="mHead">
        <div>
          <h3 id="modalTitle">ì¸ë²¤í† ë¦¬ ì„¤ì • (íƒ­ë³„ ë“±ë¡)</h3>
          <div class="sub">ê° íƒ­ì—ì„œ 3ì¢…ë¥˜ Ã— ë“±ê¸‰ ìˆ˜ëŸ‰ ì…ë ¥</div>
          <div class="mTabs" id="mTabs"></div>
        </div>
        <div class="row">
          <button class="btn danger" id="tabZero">ì¸ë²¤í† ë¦¬ ì´ˆê¸°í™”</button>
          <button class="btn" id="closeInv">ë‹«ê¸°</button>
        </div>
      </div>

      
      <div class="mBody">
        <div class="mCard" id="matCard">
          <div class="mCardHead">
            <b>ì¸ë²¤í† ë¦¬ ì¬ë£Œ (10ì¹¸ ì¤‘ 4ì¹¸)</b>
            <span class="muted">í˜¼ëˆ/ì¸ë‚´/íŒŒê´´ ì •ìˆ˜ + ë³´ì„</span>
          </div>
          <div class="mInputs" style="grid-template-columns: repeat(4, minmax(0, 1fr));">
            <label><span style="display:flex;align-items:center;gap:8px"><img class="matIcon" alt="" src="./icons/ì¬ë£Œ/í˜¼ëˆ.jpg" onerror="this.style.display='none'">í˜¼ëˆì˜ ì •ìˆ˜</span><input type="number" min="0" step="1" id="matChaos" data-mat="chaos" value="0"></label>
            <label><span style="display:flex;align-items:center;gap:8px"><img class="matIcon" alt="" src="./icons/ì¬ë£Œ/ì¸ë‚´.jpg" onerror="this.style.display='none'">ì¸ë‚´ì˜ ì •ìˆ˜</span><input type="number" min="0" step="1" id="matPatience" data-mat="patience" value="0"></label>
            <label><span style="display:flex;align-items:center;gap:8px"><img class="matIcon" alt="" src="./icons/ì¬ë£Œ/íŒŒê´´.jpg" onerror="this.style.display='none'">íŒŒê´´ì˜ ì •ìˆ˜</span><input type="number" min="0" step="1" id="matDestruction" data-mat="destruction" value="0"></label>
            <label><span style="display:flex;align-items:center;gap:8px"><img class="matIcon" alt="" src="./icons/ë³´ì„.jpg" onerror="this.style.display='none'">ë³´ì„</span><input type="number" min="0" step="1" id="matJewel" data-mat="jewel" value="0"></label>
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:10px">
            <button class="btn danger" id="matZero" title="ì¬ë£Œë¥¼ ëª¨ë‘ 0ìœ¼ë¡œ">ì¬ë£Œ ì´ˆê¸°í™”</button>
          </div>
        </div>

        <div class="mGrid" id="mGrid"></div>

      </div>

      <div class="mFoot">
        <span class="muted" id="mStatus">ì €ì¥ ì¤€ë¹„ë¨</span>
        <div class="row">
          <button class="btn primary" id="saveInv">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const rarityOrder = ["Common","Uncommon","Rare","Epic","Legend","Ancient","Chaos","Ultimate","God"];
    const rarityKr = {
      Common:"ì»¤ë¨¼", Uncommon:"ì–¸ì»¤ë¨¼", Rare:"ë ˆì–´", Epic:"ì—í”½", Legend:"ë ˆì „ë“œ",
      Ancient:"ì—ì´ì…˜íŠ¸", Chaos:"ì¹´ì˜¤ìŠ¤", Ultimate:"ì–¼í‹°ë°‹", God:"ê°“"
    };
    const perItemCost = { Common:5, Uncommon:10, Rare:20, Epic:35, Legend:50, Ancient:65, Chaos:75, Ultimate:100, God:150 };

    // ë³´ì„(ì¡°í•© ì‹œ í•„ìš”) - ë“±ê¸‰ë³„ ì†Œëª¨(1íšŒ ì¡°í•© ê¸°ì¤€)
    const jewelCost = { Common:500, Uncommon:1500, Rare:2000, Epic:3000, Legend:3000, Ancient:3000, Chaos:5000, Ultimate:5000, God:5000 };

    const gearDefs = {
      "ë¬´ê¸°": ["ë ˆì´í”¼ì–´","ê°•ì²  ëŒ€ê²€","ì „íˆ¬ ë§ì¹˜"],
      "íˆ¬êµ¬": ["í¬ë¦¬ìŠ¤íƒˆ","ê°•ì² ","ê°€ì£½"],
      "ê°‘ì˜·": ["í¬ë¦¬ìŠ¤íƒˆ","ê°•ì² ","ê°€ì£½"],
      "ì‹ ë°œ": ["í¬ë¦¬ìŠ¤íƒˆ","ê°•ì² ","ê°€ì£½"],
      "ëª©ê±¸ì´": ["ì—ë©”ë„ë“œ","ì‚¬íŒŒì´ì–´","ë£¨ë¹„"],
      "ë°©íŒ¨": ["ì›í˜•","í¬ë¦¬ìŠ¤íƒˆ","ê°•ì² "]
    };

    const essenceNames = {
      chaos: "í˜¼ëˆì˜ ê°•í™” ì •ìˆ˜",
      patience: "ì¸ë‚´ì˜ ê°•í™” ì •ìˆ˜",
      destruction: "íŒŒê´´ì˜ ê°•í™” ì •ìˆ˜"
    };

    const typeToEssence = {
      "ê°€ì£½": "destruction",
      "ê°•ì² ": "patience",
      "í¬ë¦¬ìŠ¤íƒˆ": "chaos",
      "ë ˆì´í”¼ì–´": "chaos",
      "ê°•ì²  ëŒ€ê²€": "patience",
      "ì „íˆ¬ ë§ì¹˜": "destruction",
      "ì—ë©”ë„ë“œ": "patience",
      "ì‚¬íŒŒì´ì–´": "chaos",
      "ë£¨ë¹„": "destruction",
      "í¬ë¦¬ìŠ¤íƒˆ": "chaos",
      "ê°•ì² ": "patience",
      "ì›í˜•": "destruction"
    };

    // âœ… ì•„ì´ì½˜ ê²½ë¡œ ê·œì¹™(ì‚¬ìš©ì ì´ë¯¸ì§€ í´ë”ì— ë„£ìœ¼ë©´ ìë™ìœ¼ë¡œ í‘œì‹œ)
    // í´ë” êµ¬ì¡° ì˜ˆì‹œ:
    //   ./assets/icons/ë¬´ê¸°/ë ˆì´í”¼ì–´.png
    //   ./assets/icons/ì‹ ë°œ/ê°€ì£½.png
    //   ./assets/icons/ë°©íŒ¨/ê°•ì²  ë°©íŒ¨.png
    // íŒŒì¼ëª…ì€ "íƒ€ì…(type) ê·¸ëŒ€ë¡œ" ì‚¬ìš©(ê³µë°± í¬í•¨ ê°€ëŠ¥). í™•ì¥ìëŠ” .png ê¶Œì¥.
const ICON_BASE = "./icons";

function normalizeName(str) {
  // ì•„ì´ì½˜ íŒŒì¼ëª… ê·œì¹™: ê³µë°± ì œê±°(ì˜ˆ: "ê°•ì²  ëŒ€ê²€" â†’ "ê°•ì² ëŒ€ê²€")
  return String(str)
    .trim()
    .replace(/\s+/g, "");
}

function getIconSrc(gear, type) {
  const safeGear = encodeURIComponent(normalizeName(gear));
  const safeType = encodeURIComponent(normalizeName(type));

  return `${ICON_BASE}/${safeGear}/${safeType}.jpg`;
}

    const STORAGE_KEY = "equip_calc_inventory_v3";

    function blankInventory(){
      const equipment = {};
      Object.entries(gearDefs).forEach(([gear, types]) => {
        equipment[gear] = {};
        types.forEach(t => {
          equipment[gear][t] = {};
          rarityOrder.forEach(r => { equipment[gear][t][r] = 0; });
        });
      });
      return { equipment, materials: { chaos:0, patience:0, destruction:0, jewel:0 } };
    }

    function loadInventory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return blankInventory();
        const p = JSON.parse(raw);
        const inv = blankInventory();

        Object.entries(gearDefs).forEach(([g, types]) => {
          types.forEach(t => {
            rarityOrder.forEach(r => {
              const v = p?.equipment?.[g]?.[t]?.[r];
              inv.equipment[g][t][r] = Number.isFinite(+v) ? Math.max(0, Math.floor(+v)) : 0;
            });
          });
        });

        inv.materials = (p && p.materials && typeof p.materials==="object") ? {
          chaos: Number.isFinite(+p.materials.chaos) ? Math.max(0, Math.floor(+p.materials.chaos)) : 0,
          patience: Number.isFinite(+p.materials.patience) ? Math.max(0, Math.floor(+p.materials.patience)) : 0,
          destruction: Number.isFinite(+p.materials.destruction) ? Math.max(0, Math.floor(+p.materials.destruction)) : 0,
          jewel: Number.isFinite(+p.materials.jewel) ? Math.max(0, Math.floor(+p.materials.jewel)) : 0,
        } : { chaos:0, patience:0, destruction:0, jewel:0 };

        return inv;
      }catch(e){ return blankInventory(); }
    }

    function saveInventory(inv){ localStorage.setItem(STORAGE_KEY, JSON.stringify(inv)); }

    let inventory = loadInventory();
    ensureMaterials();

    const statusPill = document.getElementById("statusPill");
    function setStatus(msg){ if(statusPill) statusPill.textContent = msg; }

    function ensureMaterials(){
      if(!inventory.materials) inventory.materials = { chaos:0, patience:0, destruction:0, jewel:0 };
      ["chaos","patience","destruction","jewel"].forEach(k=>{
        const v = inventory.materials[k];
        inventory.materials[k] = Number.isFinite(+v) ? Math.max(0, Math.floor(+v)) : 0;
      });
    }

    function renderMaterials(){
      ensureMaterials();
      // modal inputs
      if(matInputs.chaos){
        matInputs.chaos.value = inventory.materials.chaos;
        matInputs.patience.value = inventory.materials.patience;
        matInputs.destruction.value = inventory.materials.destruction;
        matInputs.jewel.value = inventory.materials.jewel;
      }
      // right panel
      if(invMatChaos){
        invMatChaos.textContent = inventory.materials.chaos.toLocaleString("ko-KR");
        invMatPatience.textContent = inventory.materials.patience.toLocaleString("ko-KR");
        invMatDestruction.textContent = inventory.materials.destruction.toLocaleString("ko-KR");
        invMatJewel.textContent = inventory.materials.jewel.toLocaleString("ko-KR");
      }
    }

    function bindMaterialInputs(){
      if(!matInputs.chaos) return;

      Object.entries(matInputs).forEach(([k, el])=>{
        el.addEventListener("input", ()=>{
          ensureMaterials();
          inventory.materials[k] = Math.max(0, Math.floor(+el.value || 0));
          saveInventory(inventory);
          renderMaterials();
          mStatus.textContent = "ë³€ê²½ë¨ (ìë™ ì €ì¥ë¨)";
        });
      });

      if(matZeroBtn){
        matZeroBtn.onclick = ()=>{
          ensureMaterials();
          inventory.materials = { chaos:0, patience:0, destruction:0, jewel:0 };
          saveInventory(inventory);
          renderMaterials();
          mStatus.textContent = "ì¬ë£Œ ì „ì²´ 0 ì²˜ë¦¬ë¨";
        };
      }
    }

    function ownedCount(gear, type, rarity){ return inventory?.equipment?.[gear]?.[type]?.[rarity] ?? 0; }
    function essenceForType(type){ return typeToEssence[type] || "chaos"; }
    function iconFor(gear, type){ return getIconSrc(gear, type) || ""; }
    function glyphFallback(gear){ return ({"ë¬´ê¸°":"W","íˆ¬êµ¬":"H","ê°‘ì˜·":"A","ì‹ ë°œ":"B","ëª©ê±¸ì´":"N","ë°©íŒ¨":"S"})[gear] || "â– "; }

    function renderIconEl(gear, type){
      const src = iconFor(gear,type);
      if(src) return `<div class="icon"><img alt="" src="${src}"/></div>`;
      return `<div class="icon"><span style="font-weight:990">${glyphFallback(gear)}Â·${(type||"").slice(0,2)}</span></div>`;
    }

    function nextRarity(r){
      const idx = rarityOrder.indexOf(r);
      return rarityOrder[Math.min(idx+1, rarityOrder.length-1)];
    }
    function canCraft(a,b){
      if(!a || !b) return { ok:false, reason:"ìŠ¬ë¡¯ì„ ì±„ì›Œì£¼ì„¸ìš”." };
      if(a.rarity !== b.rarity) return { ok:false, reason:"Aì™€ Bì˜ ë“±ê¸‰ì´ ë‹¬ë¼ìš”." };
      if(ownedCount(a.gear, a.type, a.rarity) <= 0) return { ok:false, reason:"A ë³´ìœ  ìˆ˜ëŸ‰ì´ ì—†ì–´ìš”." };
      if(ownedCount(b.gear, b.type, b.rarity) <= 0) return { ok:false, reason:"B ë³´ìœ  ìˆ˜ëŸ‰ì´ ì—†ì–´ìš”." };
      if(a.rarity === "God") return { ok:false, reason:"ê°“ ë“±ê¸‰ì€ ë” ì´ìƒ ìŠ¹ê¸‰ ë¶ˆê°€" };
      return { ok:true };
    }
    function calcNeedOne(a,b){
      const need = { chaos:0, patience:0, destruction:0, jewel:0 };
      if(!a || !b) return need;
      need[essenceForType(a.type)] += (perItemCost[a.rarity] || 0);
      need[essenceForType(b.type)] += (perItemCost[b.rarity] || 0);
      need.jewel += (jewelCost[a.rarity] || 0);
      return need;
    }

    // LEFT
    const gearTabs = document.getElementById("gearTabs");
    const rarityFilter = document.getElementById("rarityFilter");
    const iconGrid = document.getElementById("iconGrid");
    let activeGearTab = "ì‹ ë°œ";
    let activeRarity = "Uncommon";

    function renderGearTabs(){
      gearTabs.innerHTML = "";
      Object.keys(gearDefs).forEach(g => {
        const b = document.createElement("button");
        b.className = "tab" + (g===activeGearTab ? " active" : "");
        b.textContent = g;
        b.onclick = () => { activeGearTab = g; renderGearTabs(); renderIconGrid(); };
        gearTabs.appendChild(b);
      });
    }

    function renderRarityFilter(){
      rarityFilter.innerHTML = "";
      rarityOrder.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = rarityKr[r];
        rarityFilter.appendChild(opt);
      });
      rarityFilter.value = activeRarity;
      rarityFilter.onchange = () => { activeRarity = rarityFilter.value; renderIconGrid(); };
    }

    function renderIconGrid(){
      iconGrid.innerHTML = "";
      const types = gearDefs[activeGearTab];
      let any = false;

      types.forEach(typeName => {
        const count = ownedCount(activeGearTab, typeName, activeRarity);
        if(count <= 0) return;
        any = true;

        const tile = document.createElement("div");
        tile.className = "tile";
        tile.onclick = () => pickItem({ gear: activeGearTab, type: typeName, rarity: activeRarity });

        const essKey = essenceForType(typeName);
        tile.innerHTML = `
          <div class="tileTop">
            ${renderIconEl(activeGearTab, typeName)}
            <div class="qty">x ${count.toLocaleString("ko-KR")}</div>
          </div>
          <div class="name">${activeGearTab} Â· ${typeName}</div>
          <div class="rar">${rarityKr[activeRarity]}</div>
        `;
        iconGrid.appendChild(tile);
      });

      if(!any){
        const empty = document.createElement("div");
        empty.className = "out";
        empty.style.gridColumn = "1 / -1";
        empty.innerHTML = `<div class="strong">í‘œì‹œí•  ì¥ë¹„ê°€ ì—†ì–´ìš”</div><div class="muted">ì¸ë²¤í† ë¦¬ ì„¤ì •ì—ì„œ <span class="strong">${activeGearTab}</span> Â· <span class="strong">${rarityKr[activeRarity]}</span> ìˆ˜ëŸ‰ì„ 1 ì´ìƒìœ¼ë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”</div>`;
        iconGrid.appendChild(empty);
      }
      renderRightInventory();
      renderMaterials();
    }


    // Combine
    const slotAEl = document.getElementById("slotA");
    const slotBEl = document.getElementById("slotB");
    const outBox = document.getElementById("outBox");
    const doCraftBtn = document.getElementById("doCraft");
    const previewBtn = document.getElementById("previewCraft");
    const craftTimesEl = document.getElementById("craftTimes");

    const needChaos = document.getElementById("needChaos");
    const needPatience = document.getElementById("needPatience");
    const needDestruction = document.getElementById("needDestruction");
    const needJewel = document.getElementById("needJewel");

    // Materials inventory (ì •ìˆ˜/ë³´ì„)
    const matInputs = {
      chaos: document.getElementById("matChaos"),
      patience: document.getElementById("matPatience"),
      destruction: document.getElementById("matDestruction"),
      jewel: document.getElementById("matJewel"),
    };
    const matZeroBtn = document.getElementById("matZero");
    const invMatChaos = document.getElementById("invMatChaos");
    const invMatPatience = document.getElementById("invMatPatience");
    const invMatDestruction = document.getElementById("invMatDestruction");
    const invMatJewel = document.getElementById("invMatJewel");


    let slotA = null;
    let slotB = null;

    function renderPicked(item, which){
      const count = ownedCount(item.gear, item.type, item.rarity);
      const ess = essenceNames[essenceForType(item.type)];
      return `
        ${renderIconEl(item.gear, item.type)}
        <div style="display:grid;gap:2px">
          <div class="strong">${item.gear} Â· ${item.type} <span class="muted">(${rarityKr[item.rarity]})</span></div>
          <div class="muted">í˜„ì¬ ë³´ìœ : ${count} ê°œ ${ess}  1ê°œë‹¹ ${perItemCost[item.rarity]}ê°œ</div>
        </div>
        <button class="btn" style="margin-left:auto;padding:9px 10px" onclick="event.stopPropagation(); window.__clearSlot('${which}')">ë¹¼ê¸°</button>
      `;
    }
    window.__clearSlot = (which) => {
      if(which==="A") slotA = null;
      if(which==="B") slotB = null;
      updatePreview();
    };

    function renderSlots(){
      slotAEl.innerHTML = slotA ? renderPicked(slotA,"A") : `<div class="empty">ì•„ì´ì½˜ì„ í´ë¦­í•´ì„œ ì„ íƒ</div>`;
      slotBEl.innerHTML = slotB ? renderPicked(slotB,"B") : `<div class="empty">ì•„ì´ì½˜ì„ í´ë¦­í•´ì„œ ì„ íƒ</div>`;
    }
    function pickItem(item){
      if(!slotA) slotA = item;
      else if(!slotB) slotB = item;
      else slotA = item;
      updatePreview();
    }

    
    function updatePreview(){
      renderSlots();
      const check = canCraft(slotA, slotB);
      const ok = check.ok;

      const possible = (ok && slotA && slotB) ? maxCraftTimes({a:slotA,b:slotB,outR:null,need:null}, craftTimesEl.value) : 0;

      doCraftBtn.disabled = !(ok && possible>0);
      previewBtn.disabled = !(ok && possible>0);

      const need = (slotA && slotB) ? calcNeedOne(slotA, slotB) : { chaos:0, patience:0, destruction:0, jewel:0 };
      needChaos.textContent = need.chaos.toLocaleString("ko-KR");
      needPatience.textContent = need.patience.toLocaleString("ko-KR");
      needDestruction.textContent = need.destruction.toLocaleString("ko-KR");
      if(needJewel) needJewel.textContent = need.jewel.toLocaleString("ko-KR");

      if(!slotA || !slotB){
        outBox.textContent = "Aì™€ Bë¥¼ ì„ íƒí•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.";
        window.__craftPreview = null;
        return;
      }
      if(!ok){
        outBox.innerHTML = `<div class="strong bad">${check.reason}</div>`;
        window.__craftPreview = null;
        return;
      }
      const outR = nextRarity(slotA.rarity);
      outBox.innerHTML = `
        <div class="strong ok">ì¡°í•© ê°€ëŠ¥</div>
        <div style="margin-top:6px">ê²°ê³¼: <span class="strong">${slotA.gear} Â· ${slotA.type}</span> <span class="muted">(${rarityKr[outR]})</span> <span class="strong">+1</span></div>
        <div class="muted" style="margin-top:6px">
          ì†Œëª¨: A(${essenceNames[essenceForType(slotA.type)]} ${perItemCost[slotA.rarity]}) + B(${essenceNames[essenceForType(slotB.type)]} ${perItemCost[slotB.rarity]})
        </div>
      `;
      window.__craftPreview = { a: slotA, b: slotB, outR, need };
    }

    // Log
    const logEl = document.getElementById("log");
    function addLog(title, lines){
      const div = document.createElement("div");
      div.className = "logItem";
      div.innerHTML = `<div class="t">${title}</div>` + lines.map(l => `<div class="s">${l}</div>`).join("");
      logEl.prepend(div);
    }

        
    function materialsPossible(need){
      ensureMaterials();
      let possible = Infinity;
      const keys = ["chaos","patience","destruction","jewel"];
      keys.forEach(k=>{
        const n = Math.max(0, Math.floor(+need[k] || 0));
        if(n>0){
          possible = Math.min(possible, Math.floor(inventory.materials[k] / n));
        }
      });
      return Number.isFinite(possible) ? possible : 0;
    }

    function deductMaterials(need, times){
      ensureMaterials();
      const keys = ["chaos","patience","destruction","jewel"];
      keys.forEach(k=>{
        const n = Math.max(0, Math.floor(+need[k] || 0));
        inventory.materials[k] = Math.max(0, inventory.materials[k] - (n*times));
      });
      saveInventory(inventory);
      renderMaterials();
    }

    function maxCraftTimes(p, requested){
      requested = Math.max(1, Math.floor(+requested || 1));
      const aKeySameB = (p.a.gear===p.b.gear && p.a.type===p.b.type && p.a.rarity===p.b.rarity);
      const aCount = ownedCount(p.a.gear, p.a.type, p.a.rarity);
      const bCount = ownedCount(p.b.gear, p.b.type, p.b.rarity);
      const possible = aKeySameB ? Math.floor(aCount/2) : Math.min(aCount, bCount);
      return Math.min(requested, possible);
    }

    function craftOnce(p){
      const {a,b,outR} = p;
      inventory.equipment[a.gear][a.type][a.rarity] = Math.max(0, inventory.equipment[a.gear][a.type][a.rarity] - 1);
      inventory.equipment[b.gear][b.type][b.rarity] = Math.max(0, inventory.equipment[b.gear][b.type][b.rarity] - 1);
      inventory.equipment[a.gear][a.type][outR] += 1;
    }
    function doCraft(times){
      const p = window.__craftPreview;
      if(!p) return;
      const baseCheck = canCraft(p.a, p.b);
      if(!baseCheck.ok) return;

      times = Math.max(1, Math.floor(+times || 1));
      let runTimes = maxCraftTimes(p, times);
      // ì¬ë£Œ(ì •ìˆ˜/ë³´ì„)ë„ ë¶€ì¡±í•˜ë©´ ì‹¤í–‰ íšŸìˆ˜ ì œí•œ
      const matTimes = materialsPossible(p.need);
      runTimes = Math.min(runTimes, matTimes);
      if(runTimes <= 0){
        addLog("ì¡°í•© ì‹¤íŒ¨", ["ë³´ìœ  ì¥ë¹„ ë˜ëŠ” ì¬ë£Œ(ì •ìˆ˜/ë³´ì„) ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•´ì„œ ì¡°í•©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."]); 
        setStatus("ìˆ˜ëŸ‰ ë¶€ì¡±");
        updatePreview();
        return;
      }

      for(let i=0;i<runTimes;i++) craftOnce(p);

      saveInventory(inventory);
      deductMaterials(p.need, runTimes);

      addLog("ì¡°í•© ì‹¤í–‰", [
        `íšŸìˆ˜: ${runTimes}íšŒ${ runTimes < times ? " (ë³´ìœ  ìˆ˜ëŸ‰ ë¶€ì¡±ìœ¼ë¡œ ì¼ë¶€ë§Œ ì‹¤í–‰)" : "" }`,
        `A: ${p.a.gear}Â·${p.a.type} ${rarityKr[p.a.rarity]} -${runTimes}`,
        `B: ${p.b.gear}Â·${p.b.type} ${rarityKr[p.b.rarity]} -${runTimes}`,
        `ê²°ê³¼: ${p.a.gear}Â·${p.a.type} ${rarityKr[p.outR]} +${runTimes}`,
        `ì†Œëª¨: í˜¼ëˆ +${(p.need.chaos*runTimes)}, ì¸ë‚´ +${(p.need.patience*runTimes)}, íŒŒê´´ +${(p.need.destruction*runTimes)}, ë³´ì„ +${(p.need.jewel*runTimes)}`, 
        `ì¬ë£Œ ì”ì—¬: í˜¼ëˆ ${inventory.materials.chaos}, ì¸ë‚´ ${inventory.materials.patience}, íŒŒê´´ ${inventory.materials.destruction}, ë³´ì„ ${inventory.materials.jewel}`
      ]);

      if(ownedCount(p.a.gear, p.a.type, p.a.rarity) <= 0) slotA = null;
      if(ownedCount(p.b.gear, p.b.type, p.b.rarity) <= 0) slotB = null;

      setStatus("ì¡°í•© ì™„ë£Œ");
      renderIconGrid();
      renderRightInventory();
      updatePreview();
    }

    // RIGHT inventory
    const invTabsRight = document.getElementById("invTabsRight");
    const invTitle = document.getElementById("invTitle");
    const invMatrix = document.getElementById("invMatrix");
    let rightTab = "ì‹ ë°œ";
    // v6: ìš°ì¸¡ ì¸ë²¤í† ë¦¬ ë“±ê¸‰ ì°½(3ê°œì”© ë³´ì—¬ì£¼ê¸°)
    let rarityWindowStart = 0; // unused (window navigation removed)
    const rarityWindowSize = rarityOrder.length;

    function renderRightTabs(){
      invTabsRight.innerHTML = "";
      Object.keys(gearDefs).forEach(g => {
        const b = document.createElement("button");
        b.className = "tab" + (g===rightTab ? " active" : "");
        b.textContent = g;
        b.onclick = () => { rightTab = g; renderRightTabs(); renderRightInventory(); };
        invTabsRight.appendChild(b);
      });
    }
    function renderRightInventory(){
      invTitle.textContent = rightTab;
      invMatrix.innerHTML = "";

      const isNarrow = window.matchMedia("(max-width: 860px)").matches;
      const cols = isNarrow ? rarityOrder.slice(rarityWindowStart, rarityWindowStart + rarityWindowSize) : rarityOrder;

      const colCount = cols.length;
      invMatrix.style.gridTemplateColumns = `260px repeat(${colCount}, 1fr)`;

      const header = [`<div class="cell left"><span class="strong">ì¢…ë¥˜</span></div>`]
        .concat(cols.map(r => `<div class="cell">${rarityKr[r]}</div>`)).join("");
      invMatrix.insertAdjacentHTML("beforeend", header);

      gearDefs[rightTab].forEach(typeName => {
        const left = `
          <div class="cell left">
            <div class="miniIcon">${iconFor(rightTab,typeName) ? `<img alt="" src="${iconFor(rightTab,typeName)}" onerror="this.style.display='none'">` : ""}</div>
            <div>
              <div class="strong">${typeName}</div>
              <div class="muted" style="font-size:11px">${essenceNames[essenceForType(typeName)]}</div>
            </div>
          </div>`;
        const counts = cols.map(r => `<div class="cell count">${ownedCount(rightTab,typeName,r)}</div>`).join("");
        invMatrix.insertAdjacentHTML("beforeend", left + counts);
      });
    }

    // Modal inventory
    const overlay = document.getElementById("modalOverlay");
    const mTabs = document.getElementById("mTabs");
    const mGrid = document.getElementById("mGrid");
    const mStatus = document.getElementById("mStatus");
    bindMaterialInputs();
    let modalTab = "ë¬´ê¸°";

    function openModal(){ overlay.classList.add("show"); overlay.setAttribute("aria-hidden","false"); renderModalTabs(); renderModalTab(); renderMaterials(); mStatus.textContent="ì €ì¥ ì¤€ë¹„ë¨"; }
    function closeModal(){ overlay.classList.remove("show"); overlay.setAttribute("aria-hidden","true"); }

    function renderModalTabs(){
      mTabs.innerHTML = "";
      Object.keys(gearDefs).forEach(g => {
        const b = document.createElement("button");
        b.className = "mTab" + (g===modalTab ? " active" : "");
        b.textContent = g;
        b.onclick = () => { modalTab = g; renderModalTabs(); renderModalTab(); };
        mTabs.appendChild(b);
      });
    }
    function renderModalTab(){
      mGrid.innerHTML = "";
      gearDefs[modalTab].forEach(typeName => {
        const card = document.createElement("div");
        card.className = "mCard";
        card.innerHTML = `
          <div class="mCardHead">
            <div class="mHeadL">
              ${renderIconEl(modalTab, typeName)}
              <b>${modalTab} Â· ${typeName}</b>
            </div>
            <span class="muted">ì»¤ë¨¼~ê°“</span>
          </div>
          <div class="mInputs"></div>
        `;
        const inputs = card.querySelector(".mInputs");
        rarityOrder.forEach(r => {
          const lab = document.createElement("label");
          lab.innerHTML = `
            <span>${rarityKr[r]}</span>
            <input type="number" min="0" step="1" value="${ownedCount(modalTab,typeName,r)}"
              data-gear="${modalTab}" data-type="${typeName}" data-rarity="${r}">
          `;
          inputs.appendChild(lab);
        });
        mGrid.appendChild(card);
      });

      overlay.querySelectorAll("input[data-gear]").forEach(inp => {
        inp.addEventListener("input", () => mStatus.textContent = "ë³€ê²½ë¨ (ì €ì¥ í•„ìš”)");
      });
    }

    function readModalToInventory(){
      const next = loadInventory();
      overlay.querySelectorAll("input[data-gear]").forEach(inp => {
        const g = inp.dataset.gear;
        const t = inp.dataset.type;
        const r = inp.dataset.rarity;
        const v = Math.max(0, Math.floor(+inp.value || 0));
        next.equipment[g][t][r] = v;
      });
      return next;
    }

    function zeroModalTab(){
      overlay.querySelectorAll(`input[data-gear="${modalTab}"]`).forEach(i => i.value = 0);
      mStatus.textContent = "í˜„ì¬ íƒ­ ì „ì²´ 0 (ì €ì¥ í•„ìš”)";
    }

    async function exportInventory(){
      const json = JSON.stringify(inventory, null, 2);
      try{ await navigator.clipboard.writeText(json); setStatus("JSON ë³µì‚¬ë¨"); }
      catch(e){ window.prompt("ë³µì‚¬í•´ì„œ ì €ì¥:", json); }
    }
    function importInventory(){
      const pasted = window.prompt("ë¶™ì—¬ë„£ì„ ì¸ë²¤í† ë¦¬ JSON ì…ë ¥:");
      if(!pasted) return;
      try{
        const parsed = JSON.parse(pasted);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
        inventory = loadInventory();
        setStatus("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ");
        renderIconGrid(); renderRightInventory(); updatePreview();
      }catch(e){ setStatus("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨"); }
    }

    // Events
    
    // =========================
    // Event bindings
    // =========================
    document.getElementById("openInv").addEventListener("click", openModal);
    document.getElementById("closeInv").addEventListener("click", closeModal);

    // overlay click closes
    overlay.addEventListener("click", (e) => { if(e.target === overlay) closeModal(); });
    // Esc closes
    document.addEventListener("keydown", (e) => { if(e.key === "Escape" && overlay.classList.contains("show")) closeModal(); });

    // í˜„ì¬ íƒ­ 0
    document.getElementById("tabZero").addEventListener("click", () => {
      overlay.querySelectorAll(`input[data-gear="${modalTab}"]`).forEach(i => i.value = 0);
      mStatus.textContent = "í˜„ì¬ íƒ­ ì „ì²´ 0 (ì €ì¥ í•„ìš”)";
    });

    // ì €ì¥
    document.getElementById("saveInv").addEventListener("click", () => {
      inventory = readModalToInventory();
      saveInventory(inventory);
      renderGearTabs();
      renderRarityFilter();
      renderRightTabs();
      renderIconGrid();
      renderRightInventory();
      renderMaterials();
      updatePreview();
      mStatus.textContent = "ì €ì¥ë¨";
      closeModal();
      addLog("ì¸ë²¤í† ë¦¬ ì €ì¥", ["ë³´ìœ  ì¥ë¹„/ì¬ë£Œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."]);
      setStatus("ì¸ë²¤í† ë¦¬ ì €ì¥ë¨");
    });

    // ìŠ¬ë¡¯ ì´ˆê¸°í™”
    document.getElementById("clearSlots").addEventListener("click", () => {
      slotA = null; slotB = null;
      updatePreview();
      setStatus("ìŠ¬ë¡¯ ì´ˆê¸°í™”");
    });

    // ë¯¸ë¦¬ë³´ê¸° ë¡œê·¸
    document.getElementById("previewCraft").addEventListener("click", () => {
      updatePreview();
      const p = window.__craftPreview;
      if(!p){ addLog("ë¯¸ë¦¬ë³´ê¸°", ["ì„ íƒëœ ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤."]); return; }
      addLog("ë¯¸ë¦¬ë³´ê¸°", [
        `ê²°ê³¼: ${p.a.gear}Â·${p.a.type} ${rarityKr[p.outR]} +1`,
        `ì†Œëª¨(1íšŒ): í˜¼ëˆ ${p.need.chaos}, ì¸ë‚´ ${p.need.patience}, íŒŒê´´ ${p.need.destruction}, ë³´ì„ ${p.need.jewel}`
      ]);
      setStatus("ë¯¸ë¦¬ë³´ê¸° ê¸°ë¡ë¨");
    });

    // ì¡°í•© ì‹¤í–‰
    document.getElementById("doCraft").addEventListener("click", () => doCraft(craftTimesEl.value));

    // ë¡œê·¸ ì´ˆê¸°í™”
    document.getElementById("clearLog").addEventListener("click", () => {
      logEl.innerHTML = "";
      addLog("ë¡œê·¸", ["ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."]);
      setStatus("ë¡œê·¸ ì´ˆê¸°í™”");
    });

    // ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°
    const exportInvBtn = document.getElementById("exportInv");
    if(exportInvBtn) exportInvBtn.addEventListener("click", exportInventory);
    const importInvBtn = document.getElementById("importInv");
    if(importInvBtn) importInvBtn.addEventListener("click", importInventory);

// ìš°ì¸¡ ì¸ë²¤í† ë¦¬: í™”ë©´ ë¦¬ì‚¬ì´ì¦ˆ ì‹œ í‘œ ì¬ë Œë”
    window.addEventListener("resize", () => { renderRightInventory(); });

    // Init
    function init(){
      ensureMaterials();
      renderGearTabs();
      renderRarityFilter();
      renderRightTabs();
      renderIconGrid();
      renderRightInventory();
      renderMaterials();
      updatePreview();
      setStatus("ì¤€ë¹„ë¨");
    }
    init();


  </script>
</body>
</html>
